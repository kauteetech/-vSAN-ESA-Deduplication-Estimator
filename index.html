<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vSAN ESA 9.0 Deduplication Estimator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* TailAdmin Dark Theme Color Palette */
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            /* Dark Background System */
            --bg-dark: #1c2434;
            --bg-darker: #24303f;
            --bg-darkest: #1a222c;
            --surface-dark: #313d4a;
            --surface-darker: #253041;
            --surface-darkest: #1e2a37;
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #8a99af;
            --text-tertiary: #64748b;
            --text-muted: #5a6c7d;
            
            /* Border Colors */
            --border-dark: #2e3a47;
            --border-darker: #374151;
            
            /* Blue Accent (Chart colors) */
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --green-500: #10b981;
            --amber-500: #f59e0b;
            --cyan-500: #06b6d4;
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            
            /* Spacing */
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            /* Border Radius */
            --rounded-lg: 0.5rem;
            --rounded-xl: 0.75rem;
            --rounded-2xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-dark);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            color: var(--text-primary);
            font-size: var(--text-sm);
            line-height: 1.5;
        }

        .header {
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-dark);
            padding: var(--space-4) var(--space-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--rounded-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-lg);
            box-shadow: var(--shadow-md);
            color: var(--text-primary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-secondary);
            font-size: var(--text-xs);
            background: var(--surface-dark);
            padding: var(--space-2) var(--space-3);
            border-radius: 16px;
            border: 1px solid var(--border-dark);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            gap: var(--space-6);
            padding: var(--space-6);
        }

        .panel {
            background: var(--bg-darker);
            border: 1px solid var(--border-dark);
            border-radius: var(--rounded-2xl);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
        }

        .input-panel {
            width: 45%;
            display: flex;
            flex-direction: column;
        }

        .results-panel {
            width: 55%;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: var(--space-5) var(--space-6);
            background: var(--bg-darkest);
            color: var(--text-primary);
            font-weight: 600;
            font-size: var(--text-lg);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            border-bottom: 1px solid var(--border-dark);
        }

        .panel-icon {
            width: 24px;
            height: 24px;
            background: var(--surface-dark);
            border-radius: var(--rounded-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-sm);
            color: var(--text-primary);
            border: 1px solid var(--border-darker);
        }

        .panel-body {
            padding: var(--space-6);
            overflow-y: auto;
            flex: 1;
            background: var(--surface-darker);
        }

        .section {
            margin-bottom: var(--space-8);
        }

        .section-title {
            font-size: var(--text-base);
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 500;
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
            border-radius: var(--rounded-lg);
            font-size: var(--text-sm);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface-darkest);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-control:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--surface-dark);
            border-radius: var(--rounded-lg);
            border: 1px solid var(--border-dark);
            transition: all 0.3s ease;
        }

        .checkbox-wrapper:hover {
            background: var(--surface-darkest);
            border-color: var(--border-darker);
        }

        .custom-checkbox {
            position: relative;
            width: 20px;
            height: 20px;
        }

        .custom-checkbox input {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            background: var(--surface-darkest);
            border: 2px solid var(--border-darker);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .custom-checkbox input:checked + .checkmark {
            background: var(--primary);
            border-color: var(--primary);
        }

        .checkmark::after {
            content: '';
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid var(--text-primary);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .custom-checkbox input:checked + .checkmark::after {
            display: block;
        }

        /* FIXED: Enhanced clickable area for workload compression checkboxes */
        .workload-compress-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: var(--text-xs);
            padding: var(--space-2);
            border-radius: var(--rounded-lg);
            transition: all 0.3s ease;
        }

        .workload-compress-label:hover {
            color: var(--text-primary);
            background: var(--surface-darkest);
        }

        .btn {
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--rounded-xl);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--text-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            background: var(--primary-light);
        }

        .btn-outline {
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-secondary);
        }

        .btn-outline:hover {
            background: var(--surface-darkest);
            border-color: var(--border-darker);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--surface-dark);
            color: var(--text-secondary);
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-xs);
            border: 1px solid var(--border-dark);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: var(--text-primary);
            border-color: var(--danger);
        }

        .workload-item {
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
            border-radius: var(--rounded-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            transition: all 0.3s ease;
        }

        .workload-item:hover {
            background: var(--surface-darkest);
            border-color: var(--border-darker);
            transform: translateY(-1px);
        }

        .workload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .workload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .metric-card {
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
            border-radius: var(--rounded-xl);
            padding: var(--space-5);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue-500), var(--cyan-500), var(--green-500));
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: var(--surface-darkest);
            border-color: var(--border-darker);
        }

        .metric-value {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: var(--text-xs);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            height: 220px;
            margin-bottom: var(--space-6);
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
            border-radius: var(--rounded-xl);
            padding: var(--space-4);
        }

        .waterfall-chart {
            width: 100%;
            height: 100%;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--surface-dark);
            border-radius: var(--rounded-xl);
            overflow: hidden;
            border: 1px solid var(--border-dark);
        }

        .data-table th,
        .data-table td {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--border-dark);
        }

        .data-table th {
            background: var(--bg-darkest);
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .data-table tr:hover {
            background: var(--surface-darkest);
        }

        .highlight-row {
            background: var(--surface-darkest) !important;
        }

        .highlight-row td {
            font-weight: 600;
            color: var(--text-primary);
        }

        .raw-capacity-row {
            background: rgba(79, 70, 229, 0.1) !important;
        }

        .raw-capacity-row td {
            color: var(--text-primary);
            font-weight: 500;
        }

        .animation-container {
            height: 140px;
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
            border-radius: var(--rounded-xl);
            margin-bottom: var(--space-4);
            position: relative;
            overflow: hidden;
        }

        .animation-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(79, 70, 229, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.05) 0%, transparent 40%);
            animation: domainPulse 4s ease-in-out infinite;
        }

        @keyframes domainPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .dedupe-animation {
            display: flex;
            align-items: center;
            justify-content: space-around;
            height: 100%;
            position: relative;
            z-index: 2;
        }

        .host-node {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--rounded-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: 700;
            font-size: var(--text-sm);
            box-shadow: var(--shadow-md);
            animation: hostFloat 3s ease-in-out infinite;
            position: relative;
            border: 1px solid var(--border-darker);
        }

        @keyframes hostFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }

        .dedupe-domain {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            bottom: 12px;
            border: 2px dashed var(--text-tertiary);
            border-radius: var(--rounded-xl);
            animation: domainExpand 4s ease-in-out infinite;
        }

        @keyframes domainExpand {
            0%, 100% { 
                transform: scale(1);
                border-color: var(--text-tertiary);
            }
            50% { 
                transform: scale(1.02);
                border-color: var(--success);
            }
        }

        .alert {
            padding: var(--space-4);
            border-radius: var(--rounded-xl);
            margin-bottom: var(--space-4);
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
        }

        .alert-info {
            background: var(--surface-dark);
            border-color: var(--border-dark);
            color: var(--text-secondary);
        }

        .alert-danger {
            background: var(--surface-dark);
            border-left: 4px solid var(--danger);
            color: var(--text-secondary);
        }

        .alert-warning {
            background: var(--surface-dark);
            border-left: 4px solid var(--warning);
            color: var(--text-secondary);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--text-tertiary);
            margin-left: var(--space-2);
            transition: all 0.3s ease;
        }

        .tooltip:hover {
            color: var(--primary);
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-darkest);
            color: var(--text-primary);
            padding: var(--space-3);
            border-radius: var(--rounded-lg);
            font-size: var(--text-xs);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 250px;
            white-space: normal;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-dark);
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .auto-calculate-banner {
            background: var(--surface-dark);
            border: 1px solid var(--border-dark);
            padding: var(--space-3);
            border-radius: var(--rounded-xl);
            text-align: center;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Custom Scrollbar - Dark Theme */
        .panel-body::-webkit-scrollbar {
            width: 6px;
        }

        .panel-body::-webkit-scrollbar-track {
            background: var(--surface-darkest);
            border-radius: 3px;
        }

        .panel-body::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 3px;
        }

        .panel-body::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }
            
            .input-panel,
            .results-panel {
                width: 100%;
                height: auto;
            }
            
            body {
                overflow: auto;
            }
        }

        @media (max-width: 768px) {
            .form-row,
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .workload-grid {
                grid-template-columns: 1fr;
            }
            
            .main-container {
                padding: var(--space-4);
                gap: var(--space-4);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div style="display: flex; align-items: center;">
            <div class="logo">üóÑÔ∏è</div>
            <h1>vSAN ESA 9.0 Deduplication Estimator</h1>
        </div>
        <div class="status-indicator">
            <div class="status-dot"></div>
            Live Update
        </div>
    </header>

    <div class="main-container">
        <!-- Input Panel -->
        <div class="input-panel panel">
            <div class="panel-header">
                <div class="panel-icon">‚öôÔ∏è</div>
                Configuration
            </div>
            <div class="panel-body">
                <div class="auto-calculate-banner">
                    <div class="pulse-dot"></div>
                    vSAN 9.0 ESA Compliant ‚Ä¢ Results update automatically
                </div>

                <!-- Cluster Configuration -->
                <div class="section">
                    <div class="section-title">Cluster Profile</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="hosts">
                                Number of Hosts
                                <span class="tooltip" data-tooltip="vSAN ESA requires 3-64 hosts. RAID availability depends on host count per vSAN 9.0 architecture.">‚ÑπÔ∏è</span>
                            </label>
                            <input type="number" id="hosts" class="form-control" value="6" min="3" max="64">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="rawTiBPerHost">
                                Raw NVMe TiB per Host
                                <span class="tooltip" data-tooltip="ESA requires all-flash NVMe storage only. Enter total raw NVMe capacity per host.">‚ÑπÔ∏è</span>
                            </label>
                            <input type="number" id="rawTiBPerHost" class="form-control" value="20" step="0.1" min="1.6" max="500">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="raidLevel">
                                Storage Policy (RAID)
                                <span class="tooltip" data-tooltip="vSAN 9.0 ESA RAID policies: RAID-1 (3+ hosts), RAID-5 Adaptive (3+ hosts), RAID-6 (6+ hosts).">‚ÑπÔ∏è</span>
                            </label>
                            <select id="raidLevel" class="form-control">
                                <!-- Options populated dynamically -->
                            </select>
                            <div id="raidRequirement" class="alert alert-warning hidden" style="margin-top: 0.5rem; padding: 0.5rem;">
                                <!-- RAID requirement warning -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="domainMode">
                                Deduplication Scaling
                                <span class="tooltip" data-tooltip="Global deduplication domain effectiveness modeling: Conservative = safer estimates, Aggressive = higher efficiency assumptions.">‚ÑπÔ∏è</span>
                            </label>
                            <select id="domainMode" class="form-control">
                                <option value="conservative">Conservative</option>
                                <option value="typical" selected>Typical</option>
                                <option value="aggressive">Aggressive</option>
                            </select>
                        </div>
                    </div>
                    <div class="checkbox-wrapper">
                        <div class="custom-checkbox">
                            <input type="checkbox" id="compressionOn" checked>
                            <div class="checkmark"></div>
                        </div>
                        <label class="form-label" for="compressionOn" style="margin: 0;">
                            Enable Compression (Default ESA)
                            <span class="tooltip" data-tooltip="ESA enables compression by default at 512B granularity within 4KB blocks. Can be disabled per storage policy.">‚ÑπÔ∏è</span>
                        </label>
                    </div>
                </div>

                <!-- ESA Overheads -->
                <div class="section">
                    <div class="section-title">ESA System Overheads</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="lfsOverheadRate">
                                LFS Overhead (%)
                                <span class="tooltip" data-tooltip="ESA Local File System overhead ~13.1% of object + replica data. Varies by cluster utilization.">‚ÑπÔ∏è</span>
                            </label>
                            <input type="number" id="lfsOverheadRate" class="form-control" value="13.1" step="0.1" min="10" max="20">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="checksumRate">
                                Checksum Overhead (%)
                                <span class="tooltip" data-tooltip="Data integrity checksum metadata as % of effective data. ESA includes end-to-end checksums.">‚ÑπÔ∏è</span>
                            </label>
                            <input type="number" id="checksumRate" class="form-control" value="2" step="0.5" min="1" max="5">
                        </div>
                    </div>
                </div>

                <!-- Domain Animation -->
                <div class="section">
                    <div class="section-title">Global Deduplication Domain</div>
                    <div class="animation-container">
                        <div class="dedupe-animation" id="animationContainer">
                            <div class="dedupe-domain"></div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>ESA Global Domain:</strong> Unlike OSA's per-disk-group domains, ESA creates a single cluster-wide deduplication domain that improves efficiency as you add hosts.
                    </div>
                </div>

                <!-- Workloads -->
                <div class="section">
                    <div class="section-title">Workload Mix</div>
                    <div id="workloadsContainer">
                        <!-- Workload items will be added here -->
                    </div>
                    <button type="button" class="btn btn-outline" onclick="addWorkload()">
                        + Add Workload
                    </button>
                </div>

                <div id="errors" class="hidden"></div>
                <div id="warnings" class="hidden"></div>
                <div id="esaCompliance" class="hidden"></div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-panel panel">
            <div class="panel-header">
                <div class="panel-icon">üìä</div>
                Results & Analysis
            </div>
            <div class="panel-body">
                <!-- Key Metrics -->
                <div class="section">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="overallReduction">-</div>
                            <div class="metric-label">Overall Reduction</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="compressionReduction">-</div>
                            <div class="metric-label">Compression Only</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="dedupeReduction">-</div>
                            <div class="metric-label">Deduplication Only</div>
                        </div>
                    </div>
                </div>

                <!-- Waterfall Chart -->
                <div class="section">
                    <div class="section-title">ESA Capacity Transformation</div>
                    <div class="chart-container">
                        <svg class="waterfall-chart" id="waterfallChart">
                            <!-- Chart will be generated -->
                        </svg>
                    </div>
                </div>

                <!-- Capacity Breakdown -->
                <div class="section">
                    <div class="section-title">ESA Capacity Analysis</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Stage</th>
                                <th>Capacity (TiB)</th>
                                <th>ESA Description</th>
                            </tr>
                        </thead>
                        <tbody id="breakdownTable">
                            <!-- Breakdown rows -->
                        </tbody>
                    </table>
                </div>

                <!-- Per-Workload Analysis -->
                <div class="section">
                    <div class="section-title">Workload Efficiency Analysis</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Workload Type</th>
                                <th>Logical</th>
                                <th>Compressed</th>
                                <th>Dedupe Savings</th>
                                <th>Net Efficiency</th>
                            </tr>
                        </thead>
                        <tbody id="workloadDetailsTable">
                            <!-- Workload details -->
                        </tbody>
                    </table>
                </div>

                <!-- VMware vSAN 9.0 ESA Guidance -->
                <div class="section">
                    <div class="alert alert-info">
                        <strong>üè¢ VMware vSAN 9.0 ESA Architecture</strong>
                        <ul id="guidanceNotes" style="margin: 0.75rem 0 0 0; padding-left: 1.2rem; font-size: var(--text-sm); line-height: 1.6;">
                            <!-- Notes will be populated -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // vSAN 9.0 ESA Configuration and Data Models
        const DEFAULT_COMPRESSION_BY_TYPE = {
            'full_clone_vdi': { min: 2.0, max: 8.0, default: 4.0 },
            'unstructured': { min: 1.2, max: 2.5, default: 1.6 },
            'oltp_sql': { min: 1.0, max: 1.6, default: 1.2 },
            'encrypted': { min: 1.0, max: 1.05, default: 1.0 },
            'backup': { min: 1.5, max: 3.0, default: 2.0 }
        };

        const DEFAULT_SIMILARITY = {
            'full_clone_vdi': 0.85,
            'unstructured': 0.35,
            'oltp_sql': 0.15,
            'encrypted': 0.0,
            'backup': 0.5
        };

        const WORKLOAD_TYPES = {
            'full_clone_vdi': 'VDI Clones',
            'unstructured': 'Unstructured',
            'oltp_sql': 'OLTP/SQL',
            'encrypted': 'Encrypted',
            'backup': 'Backup'
        };

        // VMware vSAN 9.0 ESA RAID Requirements (OFFICIAL COMPLIANCE)
        const VSAN_ESA_RAID_REQUIREMENTS = {
            raid1: { 
                minHosts: 3, 
                overhead: 2.0, 
                description: 'RAID-1 Mirror (FTT=1)',
                esaScheme: '1+1 Mirroring'
            },
            raid5: { 
                minHosts: 3, 
                overhead: 1.25, 
                description: 'RAID-5 Adaptive Erasure Coding (FTT=1)',
                esaScheme: '2+1 or 4+1 Adaptive'
            },
            raid6: { 
                minHosts: 6, 
                overhead: 1.5, 
                description: 'RAID-6 Erasure Coding (FTT=2)',
                esaScheme: '4+2 Erasure Coding'
            }
        };

        // ESA Platform Limits (vSAN 9.0)
        const ESA_LIMITS = {
            maxHosts: 64,
            maxVMsPerHost: 500,
            maxComponentsPerHost: 27000,
            avgComponentsPerVM: 54,
            minNVMeCapacityTiB: 1.6,
            maxNVMeCapacityTiB: 500,
            lfsOverheadPercent: 13.1,
            checksumOverheadPercent: 2.0
        };

        let workloadCounter = 0;

        // Utility functions
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function safeDiv(a, b) {
            return b === 0 ? 0 : a / b;
        }

        function domainScalingFactor(hosts, mode) {
            // ESA Global Domain scaling - more aggressive than OSA due to cluster-wide domain
            const cap = mode === 'aggressive' ? 1.0 : mode === 'typical' ? 0.85 : 0.7;
            const k = mode === 'aggressive' ? 0.25 : mode === 'typical' ? 0.20 : 0.15;
            const x = Math.max(0, hosts - 2);
            return cap * (1 - Math.exp(-k * x));
        }

        function formatNumber(num, decimals = 1) {
            return parseFloat(num).toFixed(decimals);
        }

        // ESA COMPLIANCE: Dynamic RAID Options Based on Host Count
        function updateRaidOptions(hostCount) {
            const raidSelect = document.getElementById('raidLevel');
            const raidWarning = document.getElementById('raidRequirement');
            const currentValue = raidSelect.value;
            
            raidSelect.innerHTML = '';
            
            const availableRaids = [];
            let warnings = [];
            
            // Check each RAID type against vSAN ESA requirements
            Object.entries(VSAN_ESA_RAID_REQUIREMENTS).forEach(([raidType, req]) => {
                if (hostCount >= req.minHosts) {
                    availableRaids.push({
                        value: raidType,
                        label: req.description,
                        scheme: req.esaScheme
                    });
                } else {
                    warnings.push(`${req.description} requires minimum ${req.minHosts} hosts (ESA ${req.esaScheme})`);
                }
            });
            
            // Add available options
            availableRaids.forEach(raid => {
                const option = document.createElement('option');
                option.value = raid.value;
                option.textContent = raid.label;
                raidSelect.appendChild(option);
            });
            
            // Set selection
            if (availableRaids.find(r => r.value === currentValue)) {
                raidSelect.value = currentValue;
            } else {
                const defaultRaid = availableRaids.find(r => r.value === 'raid5') || availableRaids[0];
                if (defaultRaid) {
                    raidSelect.value = defaultRaid.value;
                }
            }
            
            // Show warnings
            if (warnings.length > 0 && hostCount < 6) {
                raidWarning.innerHTML = `<strong>ESA RAID Limitations:</strong><br>${warnings.join('<br>')}`;
                raidWarning.classList.remove('hidden');
            } else {
                raidWarning.classList.add('hidden');
            }
            
            return availableRaids.length > 0;
        }

        // FIXED: Enhanced createWorkloadItem with proper clickable compression checkbox
        function createWorkloadItem(type = 'unstructured', logicalTiB = 50, coldPct = 0.6, compressionEnabled = true) {
            const id = workloadCounter++;
            const item = document.createElement('div');
            item.className = 'workload-item';
            item.dataset.id = id;
            
            item.innerHTML = `
                <div class="workload-header">
                    <select class="form-control workload-type" data-id="${id}" style="width: 45%;">
                        ${Object.entries(WORKLOAD_TYPES).map(([key, label]) => 
                            `<option value="${key}" ${key === type ? 'selected' : ''}>${label}</option>`
                        ).join('')}
                    </select>
                    <label for="workload-compression-${id}" class="workload-compress-label">
                        <div class="custom-checkbox">
                            <input type="checkbox" 
                                   id="workload-compression-${id}" 
                                   class="workload-compression" 
                                   data-id="${id}" 
                                   ${compressionEnabled ? 'checked' : ''} 
                                   title="Per-workload compression via SPBM">
                            <div class="checkmark"></div>
                        </div>
                        <span>Compress</span>
                    </label>
                    <button type="button" class="btn btn-danger" onclick="removeWorkload(${id})" title="Remove workload">√ó</button>
                </div>
                <div class="workload-grid">
                    <div class="form-group">
                        <label class="form-label">Logical Data (TiB)</label>
                        <input type="number" class="form-control workload-logical" data-id="${id}" 
                               value="${logicalTiB}" step="1" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cold Data Ratio</label>
                        <input type="number" class="form-control workload-cold" data-id="${id}" 
                               value="${coldPct}" step="0.1" min="0" max="1" placeholder="0.0 - 1.0">
                    </div>
                </div>
            `;
            
            // Add event listeners for all inputs including compression checkbox
            item.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', autoCalculate);
                input.addEventListener('change', autoCalculate);
            });
            
            return item;
        }

        function addWorkload(type = 'unstructured', logicalTiB = 50, coldPct = 0.6) {
            const container = document.getElementById('workloadsContainer');
            const item = createWorkloadItem(type, logicalTiB, coldPct, true);
            container.appendChild(item);
            autoCalculate();
        }

        function removeWorkload(id) {
            const item = document.querySelector(`[data-id="${id}"]`);
            if (item) {
                item.style.transform = 'translateX(-100%)';
                item.style.opacity = '0';
                setTimeout(() => {
                    item.remove();
                    autoCalculate();
                }, 300);
            }
        }

        // FIXED: Enhanced getWorkloads to properly read compression checkbox state
        function getWorkloads() {
            return Array.from(document.querySelectorAll('.workload-item')).map(item => {
                const id = item.dataset.id;
                const typeSelect = item.querySelector('.workload-type');
                const logicalInput = item.querySelector('.workload-logical');
                const coldInput = item.querySelector('.workload-cold');
                const compressionInput = item.querySelector('.workload-compression');
                
                return {
                    id: id,
                    type: typeSelect ? typeSelect.value : 'unstructured',
                    logicalTiB: logicalInput ? parseFloat(logicalInput.value) || 0 : 0,
                    coldPct: coldInput ? parseFloat(coldInput.value) || 0 : 0,
                    compressionEnabled: compressionInput ? compressionInput.checked : true
                };
            });
        }

        // ESA COMPLIANCE: Enhanced validation
        function validateInputs() {
            const errors = [];
            const warnings = [];
            const hosts = parseInt(document.getElementById('hosts').value) || 0;
            const rawTiBPerHost = parseFloat(document.getElementById('rawTiBPerHost').value) || 0;
            const raidLevel = document.getElementById('raidLevel').value;
            
            // ESA Host limits
            if (hosts < 3) {
                errors.push('vSAN ESA requires minimum 3 hosts for quorum.');
            }
            if (hosts > ESA_LIMITS.maxHosts) {
                errors.push(`vSAN ESA supports maximum ${ESA_LIMITS.maxHosts} hosts per cluster.`);
            }
            
            // ESA RAID validation
            if (raidLevel && VSAN_ESA_RAID_REQUIREMENTS[raidLevel]) {
                const minRequired = VSAN_ESA_RAID_REQUIREMENTS[raidLevel].minHosts;
                if (hosts < minRequired) {
                    errors.push(`${VSAN_ESA_RAID_REQUIREMENTS[raidLevel].description} requires minimum ${minRequired} hosts.`);
                }
            }
            
            // ESA NVMe validation
            if (rawTiBPerHost < ESA_LIMITS.minNVMeCapacityTiB) {
                errors.push(`ESA requires minimum ${ESA_LIMITS.minNVMeCapacityTiB} TiB NVMe per host.`);
            }
            if (rawTiBPerHost > ESA_LIMITS.maxNVMeCapacityTiB) {
                warnings.push(`${rawTiBPerHost} TiB per host exceeds typical ESA configurations (${ESA_LIMITS.maxNVMeCapacityTiB} TiB max tested).`);
            }
            
            const workloads = getWorkloads();
            const totalLogical = workloads.reduce((sum, w) => sum + w.logicalTiB, 0);
            if (totalLogical <= 0) errors.push('Total logical dataset must be > 0.');
            
            // ESA VM density validation
            const estimatedVMs = totalLogical / 2; // Rough estimate: 2TiB per VM average
            if (estimatedVMs > (hosts * ESA_LIMITS.maxVMsPerHost)) {
                warnings.push(`Estimated ${Math.round(estimatedVMs)} VMs may exceed ESA limit of ${ESA_LIMITS.maxVMsPerHost} VMs per host.`);
            }
            
            return { errors, warnings };
        }

        // ESA COMPLIANCE: Complete calculation engine with LFS overhead
        function calculateEstimate() {
            const hosts = parseInt(document.getElementById('hosts').value) || 6;
            const rawTiBPerHost = parseFloat(document.getElementById('rawTiBPerHost').value) || 20;
            const raidLevel = document.getElementById('raidLevel').value || 'raid5';
            
            // Physical capacity limits
            const totalRawCapacity = hosts * rawTiBPerHost;
            const raidOverhead = VSAN_ESA_RAID_REQUIREMENTS[raidLevel]?.overhead || 1.25;
            const usableRawCapacity = totalRawCapacity / raidOverhead;
            
            const globalCompressionOn = document.getElementById('compressionOn').checked;
            const domainMode = document.getElementById('domainMode').value || 'typical';
            const lfsOverheadRate = (parseFloat(document.getElementById('lfsOverheadRate').value) || 13.1) / 100;
            const checksumRate = (parseFloat(document.getElementById('checksumRate').value) || 2) / 100;
            
            const workloads = getWorkloads();
            const logicalTotal = workloads.reduce((sum, w) => sum + w.logicalTiB, 0);
            
            if (logicalTotal === 0) {
                throw new Error('No workload data available');
            }
            
            // ESA Phase 1: Per-workload compression (512B granularity) - FIXED
            const perWorkload = workloads.map(w => {
                const compressionProfile = DEFAULT_COMPRESSION_BY_TYPE[w.type] || { default: 1.0 };
                // FIXED: Use individual workload compression setting
                const compressionFactor = (globalCompressionOn && w.compressionEnabled) ? compressionProfile.default : 1.0;
                const compressed = w.logicalTiB / compressionFactor;
                const cold = compressed * clamp(w.coldPct, 0, 1);
                
                return { ...w, compressed, cold, compressionFactor };
            });
            
            const totalCompressed = perWorkload.reduce((sum, p) => sum + p.compressed, 0);
            
            // ESA Phase 2: Global deduplication (4KB blocks, post-processing)
            const domainScaling = domainScalingFactor(hosts, domainMode);
            
            let totalDedupeSavings = 0;
            const perWorkloadFinal = perWorkload.map(p => {
                const similarity = DEFAULT_SIMILARITY[p.type] || 0;
                const dedupeProbability = clamp(similarity * domainScaling, 0, 1);
                // ESA post-processing efficiency - conservative
                const efficiency = (globalCompressionOn && p.compressionEnabled) ? 0.6 : 0.75;
                const dedupeSavings = clamp(p.cold * dedupeProbability * efficiency, 0, p.cold);
                
                totalDedupeSavings += dedupeSavings;
                
                return { ...p, similarity, dedupeSavings, dedupeProbability };
            });
            
            const afterDedupe = totalCompressed - totalDedupeSavings;
            
            // ESA Phase 3: LFS overhead (on object + replica data)
            const replicaData = afterDedupe * (raidOverhead - 1);
            const objectAndReplica = afterDedupe + replicaData;
            const lfsOverhead = objectAndReplica * lfsOverheadRate;
            
            // ESA Phase 4: Checksum overhead
            const checksumOverhead = afterDedupe * checksumRate;
            
            // ESA Final: Net effective capacity
            const netEffective = afterDedupe + lfsOverhead + checksumOverhead;
            
            // Capacity validation and warnings
            const capacityUtilization = (netEffective / usableRawCapacity) * 100;
            const overallReduction = safeDiv(logicalTotal, netEffective);
            const compressionOnly = safeDiv(logicalTotal, totalCompressed);
            const dedupeOnly = safeDiv(totalCompressed, afterDedupe);
            
            // ESA compliance warnings
            const warnings = [];
            const compliance = [];
            
            if (netEffective > usableRawCapacity) {
                warnings.push(`üö® CAPACITY VIOLATION: Net effective (${formatNumber(netEffective, 1)} TiB) exceeds usable raw (${formatNumber(usableRawCapacity, 1)} TiB)`);
            }
            if (capacityUtilization > 85) {
                warnings.push(`‚ö†Ô∏è HIGH UTILIZATION: ${formatNumber(capacityUtilization, 1)}% of usable capacity (ESA recommends <85%)`);
            }
            if (overallReduction > 8) {
                warnings.push(`‚ö†Ô∏è AGGRESSIVE EFFICIENCY: ${formatNumber(overallReduction, 1)}x reduction may require validation`);
            }
            
            // ESA compliance checks
            if (rawTiBPerHost >= ESA_LIMITS.minNVMeCapacityTiB) {
                compliance.push('‚úÖ ESA NVMe storage requirement met');
            }
            if (hosts >= 3 && hosts <= ESA_LIMITS.maxHosts) {
                compliance.push('‚úÖ ESA host count within supported range');
            }
            if (raidLevel === 'raid5' && hosts >= 3) {
                compliance.push('‚úÖ ESA adaptive RAID-5 configuration supported');
            }
            
            const raidDescription = VSAN_ESA_RAID_REQUIREMENTS[raidLevel]?.description || 'Unknown RAID';
            const esaScheme = VSAN_ESA_RAID_REQUIREMENTS[raidLevel]?.esaScheme || 'Unknown';
            
            return {
                logicalTotal, totalCompressed, afterDedupe, lfsOverhead, checksumOverhead,
                raidOverhead, netEffective, overallReduction, compressionOnly, dedupeOnly,
                perWorkloadFinal, domainScaling, raidLevel, raidDescription, esaScheme,
                totalRawCapacity, usableRawCapacity, capacityUtilization, warnings, compliance,
                replicaData, objectAndReplica,
                notes: [
                    `ESA Architecture: ${esaScheme} with ${formatNumber((raidOverhead - 1) * 100, 0)}% overhead`,
                    'Global deduplication domain spans entire cluster (no disk groups in ESA)',
                    '4KB block deduplication with post-processing (no write-path impact)',
                    '512B compression granularity within 4KB blocks (per storage policy)',
                    `LFS overhead: ${formatNumber(lfsOverheadRate * 100, 1)}% of object + replica data`,
                    `Domain scaling: ${formatNumber(domainScaling, 3)} effectiveness (${hosts} hosts, ${domainMode})`
                ]
            };
        }

        function updateAnimation(hosts) {
            const container = document.getElementById('animationContainer');
            
            container.querySelectorAll('.host-node').forEach(node => node.remove());
            
            const maxHosts = Math.min(hosts, 6);
            for (let i = 0; i < maxHosts; i++) {
                const node = document.createElement('div');
                node.className = 'host-node';
                node.textContent = i + 1;
                node.style.animationDelay = `${i * 0.3}s`;
                container.appendChild(node);
            }
            
            if (hosts > 6) {
                const node = document.createElement('div');
                node.className = 'host-node';
                node.textContent = `+${hosts - 6}`;
                node.style.fontSize = '0.7rem';
                node.style.animationDelay = '1.8s';
                container.appendChild(node);
            }
        }

        function createWaterfallChart(result) {
            const svg = document.getElementById('waterfallChart');
            svg.innerHTML = '';
            
            const width = 500;
            const height = 180;
            const margin = { top: 20, right: 20, bottom: 50, left: 50 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            const data = [
                { label: 'Raw NVMe', value: result.totalRawCapacity, color: '#64748b', gradient: '#94a3b8' },
                { label: 'Usable Raw', value: result.usableRawCapacity, color: '#6b7280', gradient: '#9ca3af' },
                { label: 'Logical Data', value: result.logicalTotal, color: '#3b82f6', gradient: '#60a5fa' },
                { label: 'Compressed', value: result.totalCompressed, color: '#10b981', gradient: '#34d399' },
                { label: 'After Dedupe', value: result.afterDedupe, color: '#f59e0b', gradient: '#fbbf24' },
                { label: 'Net Effective', value: result.netEffective, color: '#06b6d4', gradient: '#22d3ee' }
            ];
            
            const maxValue = Math.max(...data.map(d => d.value));
            const barWidth = chartWidth / data.length * 0.7;
            const barSpacing = chartWidth / data.length;
            
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            svg.appendChild(defs);
            
            data.forEach((d, i) => {
                const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                gradient.setAttribute('id', `gradient${i}`);
                gradient.setAttribute('x1', '0%');
                gradient.setAttribute('y1', '0%');
                gradient.setAttribute('x2', '0%');
                gradient.setAttribute('y2', '100%');
                
                const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop1.setAttribute('offset', '0%');
                stop1.setAttribute('stop-color', d.gradient);
                
                const stop2 = document.createElementNS('http://www.w3.svg', 'stop');
                stop2.setAttribute('offset', '100%');
                stop2.setAttribute('stop-color', d.color);
                
                gradient.appendChild(stop1);
                gradient.appendChild(stop2);
                defs.appendChild(gradient);
            });
            
            data.forEach((d, i) => {
                const barHeight = (d.value / maxValue) * chartHeight;
                const x = margin.left + i * barSpacing + (barSpacing - barWidth) / 2;
                const y = margin.top + chartHeight - barHeight;
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', `url(#gradient${i})`);
                rect.setAttribute('rx', '4');
                rect.setAttribute('opacity', i < 2 ? '0.6' : '0.9');
                svg.appendChild(rect);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + barWidth / 2);
                text.setAttribute('y', height - 15);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '10');
                text.setAttribute('fill', '#8a99af');
                text.setAttribute('font-weight', '500');
                text.textContent = d.label;
                svg.appendChild(text);
                
                const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                valueText.setAttribute('x', x + barWidth / 2);
                valueText.setAttribute('y', y - 8);
                valueText.setAttribute('text-anchor', 'middle');
                valueText.setAttribute('font-size', '9');
                valueText.setAttribute('fill', '#64748b');
                valueText.setAttribute('font-weight', '600');
                valueText.textContent = formatNumber(d.value, 0) + ' TiB';
                svg.appendChild(valueText);
            });
        }

        function displayResults(result) {
            document.getElementById('overallReduction').textContent = formatNumber(result.overallReduction, 1) + 'x';
            document.getElementById('compressionReduction').textContent = formatNumber(result.compressionOnly, 1) + 'x';
            document.getElementById('dedupeReduction').textContent = formatNumber(result.dedupeOnly, 1) + 'x';
            
            // ESA-specific breakdown table
            const breakdownTable = document.getElementById('breakdownTable');
            const hosts = parseInt(document.getElementById('hosts').value) || 6;
            breakdownTable.innerHTML = `
                <tr class="raw-capacity-row"><td>Raw NVMe Capacity</td><td>${formatNumber(result.totalRawCapacity, 1)} TiB</td><td>All-flash NVMe across ${hosts} ESA hosts</td></tr>
                <tr class="raw-capacity-row"><td>Usable Raw Capacity</td><td>${formatNumber(result.usableRawCapacity, 1)} TiB</td><td>After ${result.esaScheme} overhead</td></tr>
                <tr><td>Logical Dataset</td><td>${formatNumber(result.logicalTotal, 1)} TiB</td><td>VM workload data before efficiency</td></tr>
                <tr><td>After ESA Compression</td><td>${formatNumber(result.totalCompressed, 1)} TiB</td><td>512B compression within 4KB blocks</td></tr>
                <tr><td>After ESA Deduplication</td><td>${formatNumber(result.afterDedupe, 1)} TiB</td><td>4KB global post-processing deduplication</td></tr>
                <tr><td>ESA LFS Overhead</td><td>+${formatNumber(result.lfsOverhead, 1)} TiB</td><td>Local File System metadata (${formatNumber((result.lfsOverhead / result.objectAndReplica) * 100, 1)}%)</td></tr>
                <tr><td>Checksum Overhead</td><td>+${formatNumber(result.checksumOverhead, 1)} TiB</td><td>End-to-end data integrity</td></tr>
                <tr class="highlight-row"><td>Net Effective Capacity</td><td>${formatNumber(result.netEffective, 1)} TiB</td><td>Final ESA storage consumption (${formatNumber(result.capacityUtilization, 1)}% utilization)</td></tr>
            `;
            
            // FIXED: Enhanced workload details table with compression status
            const workloadDetailsTable = document.getElementById('workloadDetailsTable');
            workloadDetailsTable.innerHTML = result.perWorkloadFinal.map(w => `
                <tr>
                    <td>${WORKLOAD_TYPES[w.type]} ${w.compressionEnabled ? 'üóúÔ∏è' : '‚ûñ'}</td>
                    <td>${formatNumber(w.logicalTiB, 1)} TiB</td>
                    <td>${formatNumber(w.compressed, 1)} TiB</td>
                    <td>${formatNumber(w.dedupeSavings, 1)} TiB</td>
                    <td>${formatNumber(safeDiv(w.logicalTiB, w.compressed - w.dedupeSavings), 1)}x</td>
                </tr>
            `).join('');
            
            const guidanceNotes = document.getElementById('guidanceNotes');
            guidanceNotes.innerHTML = result.notes.map(note => `<li>${note}</li>`).join('');
            
            createWaterfallChart(result);
            
            showWarnings(result.warnings);
            showESACompliance(result.compliance);
        }

        function showErrors(errors) {
            const errorDiv = document.getElementById('errors');
            if (errors.length > 0) {
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = '<strong>‚ö†Ô∏è Configuration Errors:</strong><ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem;">' + 
                    errors.map(error => `<li>${error}</li>`).join('') + '</ul>';
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
            }
        }

        function showWarnings(warnings) {
            const warningDiv = document.getElementById('warnings');
            if (warnings.length > 0) {
                warningDiv.className = 'alert alert-warning';
                warningDiv.innerHTML = '<strong>‚ö†Ô∏è Capacity Warnings:</strong><ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem;">' + 
                    warnings.map(warning => `<li>${warning}</li>`).join('') + '</ul>';
                warningDiv.classList.remove('hidden');
            } else {
                warningDiv.classList.add('hidden');
            }
        }

        function showESACompliance(compliance) {
            const complianceDiv = document.getElementById('esaCompliance');
            if (compliance.length > 0) {
                complianceDiv.className = 'alert alert-info';
                complianceDiv.innerHTML = '<strong>üè¢ ESA Compliance Status:</strong><ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem;">' + 
                    compliance.map(item => `<li>${item}</li>`).join('') + '</ul>';
                complianceDiv.classList.remove('hidden');
            } else {
                complianceDiv.classList.add('hidden');
            }
        }

        let calculationTimeout;
        function autoCalculate() {
            clearTimeout(calculationTimeout);
            calculationTimeout = setTimeout(() => {
                try {
                    const validation = validateInputs();
                    showErrors(validation.errors);
                    
                    if (validation.errors.length === 0) {
                        const result = calculateEstimate();
                        displayResults(result);
                    }
                } catch (error) {
                    console.error('Calculation error:', error);
                    showErrors(['Calculation failed: ' + error.message]);
                    showWarnings([]);
                    showESACompliance([]);
                }
            }, 200);
        }

        function handleHostCountChange() {
            const hosts = parseInt(document.getElementById('hosts').value) || 3;
            
            updateRaidOptions(hosts);
            updateAnimation(hosts);
            autoCalculate();
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateRaidOptions(6);
            
            // Add ESA-representative workloads
            addWorkload('full_clone_vdi', 80, 0.85, true);
            addWorkload('oltp_sql', 60, 0.4, true);
            addWorkload('unstructured', 100, 0.7, true);
            
            document.querySelectorAll('input, select').forEach(input => {
                if (input.id === 'hosts') {
                    input.addEventListener('input', handleHostCountChange);
                    input.addEventListener('change', handleHostCountChange);
                } else {
                    input.addEventListener('input', autoCalculate);
                    input.addEventListener('change', autoCalculate);
                }
            });
            
            updateAnimation(6);
            setTimeout(autoCalculate, 200);
        });
    </script>
</body>
</html>
